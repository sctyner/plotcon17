---
title: "Network Model<br>Visualization"
subtitle: "Understanding<br>complicated<br>network models<br>through visualization"
author: "Sam Tyner<br><img src ='img/twitter.png' style='width:30px;'> @sctyner <br> <img src ='img/github.png' style='width:30px;'> @sctyner"
output: 
  slidy_presentation:
    css: myslidy.css
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, cache = TRUE)
```

## Outline

- Motivation
- Working Example
- Model
- Visualizations
    * Static
    * Animation
    * Interactivity with `plotly`

## Motivating Example

Childhood vaccination - major public health concern

- [Vaccination animation](https://www.theguardian.com/society/ng-interactive/2015/feb/05/-sp-watch-how-measles-outbreak-spreads-when-kids-get-vaccinated)

<img src="img/guardian.png" alt="Screenshot of animation from The Guardian" style="width:600px;">

## Questions

Interactions in animation aren't realistic - people don't behave like bacteria in petri dishes!

- How do communities affect vaccination rate?
- How do communities affect spread of disease from outside source? 
- What factors lead to unvaccinated children?
- Can communities be identified and targeted for immunization programs?

> Can network modeling answer these? 

## Working Example

Another public health concern - underage drinking & smoking

> How do friendships influence drinking and smoking behavior in teenagers?

Steglich, Snijders & Pearson (2010) "Dynamic Networks and Behavior: Searating Selection from Influence"

## Data

From "Teenage Friends and Lifestyle Study" (Pearson & Mitchell (2000); Pearson & West (2003))

- Glasgow, Scotland, UK, Feb 1995 - Jan 1997
- Panel data - three waves - aged 12-13 to 14-15
- Each student lists up to 6 school friends
- Smoking & drinking behavior, other lifestyle variables collected
- 160 students in total, only 50 in [example data](https://www.stats.ox.ac.uk/~snijders/siena/)

## Model

- Want: to determine how friendships change risky behavior and vice versa over time
- Solution: stochastic actor-oriented models (SAOMs) for networks (Snijders 1996)
    * Stochastic because they model network change over time
    * Actor-oriented because actor-level covariates are incorporated into model parameters XX EXAMPLE XX
    
## Underlying Mechanisms?

Network changes

- Change doesn't happen all at once, but network observations are discrete
- Changes are dependent, with a highly complex structure
- How to model process? 
    * Continuous-time Markov chains (CTMCs)
    * Condition on wave 1
    * Choose one actor (call it $i$) to (potentially) make a change
    * Optimize some utility function by changing ties - choose "best" friend to have or "worst" friend to cut loose 
    
## Rate Function

Rate at which actors are selected to act

- Simple rate parameter, $\alpha$, for all actors
- Waiting time for *one* actor to act is distributed $Exp(\alpha^{-1})$
- Waiting time for *any* actor to act is distributed $Exp((n\alpha)^{-1})$
- Probability that actor $i$ will be the next one to act is $\frac{1}{n}$

## Objective Function

When actor $i$ can change, it tries to maximize its objective function:

$$f_i(x, \mathbf{z}, \boldsymbol{\beta}) = \sum_k \beta_k s_{ik}(x, \mathbf{z})$$

- $x$ is the network state
- $\mathbf{z}$ is a matrix of actor-level covariates
- $s_{ik}(x, \mathbf{z})$ are network & covariate statistics
- $\beta_k$ are the parameters to be fit in the model
- There can be any number of $\beta_k$ added to the model (problematic)

## Transition Probability

The probability that actor $i$ will change the tie to actor $j$ is: 

$$p_{ij} = \frac{\exp\left\{f_i(x(i\leadsto j), \mathbf{z}, \boldsymbol{\beta})\right\}}{\sum_h \exp\left\{f_i(x(i\leadsto h), \mathbf{z}, \boldsymbol{\beta})\right\}}$$
- $x(i\leadsto j)$ is the network identical to the current state, $x$, except for $x_{ij}$, which becomes $1-x_{ij}$ 


## (Some) Possible Model Parameters 

Structural Effect | Sufficient Statistic | Interpretation
------------------|----------------------|----------------
outdegree*        | $s_{i1}(x) = \sum_j x_{ij}$ | Popularity
reciprocity*       | $s_{i2}(x) = \sum_j x_{ij}x_{ji}$ | Reciprocated relationships
transitive triplets | $s_{i3}(x) = \sum_{j,h} x_{ij}x_{jh}x_{ih}$ | Your friend becomes my friend

Covariate Effect | Sufficient Statistic | Interpretation
-----------------|----------------------|-----------------
covariate-alter  | $s_{i4}(x) = \sum_j x_{ij}z_j$ | Effect of my friend's behavior on friendship
covariate-ego    | $s_{i5}(x) = z_i\sum_j x_{ij}$ | Effect of my behavior on friendship
same covariate   | $s_{i6}(x) = \sum_j x_{ij} \mathbb{I}(z_i = z_j)$ | Birds of a feather flock together

## Small SAOMs Example

- Small subset of the 50 friends data
- Fit three models for network evolution
- M1: "straw man" model that only has 2 parameters in obective function
- M2: M1 with one significant *covariate* effect added (drinking behavior)
- M3: M1 with one significant *structural* effect added (XX LOOK UP INTERPRETATION XX )


## Static Visualizations

- Collections of models & corresponding parameter estimates
- "Heatmap" of probabilities

## Distributions of Fitted Model Effects 

```{r distests}
library(tidyverse)
library(plotly)
simu2 <- read_csv("data/simulation-1000-M1-M2-M3.csv")
p <- ggplot(data = simu2) + 
  geom_density(aes(x = estimate, fill = Model), alpha = .5) + 
  facet_wrap(~parameter, scales = 'free') + 
  theme_bw()
ggplotly(p)
```

## Correlation of Estimates

```{r corplot}
library(GGally)
simu_spread <- simu2 %>% spread(parameter, estimate)
p <- ggpairs(simu_spread, columns = 3:8, ggplot2::aes(colour=Model, alpha = .5)) + theme_bw()
p
#ggplotly(p)
```

## "Heatmap"

```{r heatmap}
library(RSiena)
library(geomnet)
load("data/ansnullpaper.rda")
ansnullchains <- netvizinf::get_chain_info(ansnull)
chainsms <- ansnullchains %>% 
  group_by(rep, period) %>% 
  mutate(microstep = row_number(), 
         prob = exp(logAlterProb),
         from = paste0("V", as.numeric(as.character(ego))+1),
      to = paste0("V", as.numeric(as.character(alter))+1)) %>%
  ungroup()

fd2.w1 <- s501[20:35, 20:35]
colnames(fd2.w1) <- paste0("V", 1:16)
rownames(fd2.w1) <- paste0("V", 1:16)
wave1friends <- fortify(as.adjmat(fd2.w1))
ms1 <- netvizinf::listMicrosteps(dat = wave1friends,
                      microsteps = filter(chainsms, rep == 3, period == 1))

ms1df <- plyr::rbind.fill(lapply(X = seq_along(ms1), FUN = function(i, x) {
        x[[i]]$ms <- i - 1
        return(x[[i]])
    }, ms1))
# first do just the first rep's microsteps for PCA
# ms1df %>% group_by(from, to) %>% count() %>% 
#   spread(to, n, fill = 0) %>% data.frame -> dopca
# rownames(dopca) <- dopca$from
# dopca <- as.matrix(dopca[,-1])
# pca.ms1 <- prcomp(dopca)
# absorder <- names(sort(abs(pca.ms1$rotation[,1]), decreasing = T))
# raworder <- names(sort(pca.ms1$rotation[,1], decreasing = T))
# 
# chainsms %>%
#   filter(microstep == 1 & period == 1) %>% 
#   select(-rep) %>% unique %>% 
#   ggplot() + 
#   geom_tile(aes(x = factor(from, levels = raworder), 
#                 y = factor(to, levels = raworder), fill = prob))

# hm i don't like the look of that, now try PCA on matrix of all 1000 first ms's

chainsms %>%
  filter(microstep == 1 & period == 1) %>% 
  group_by(from, to) %>% count %>%
  spread(to, n, fill = 0)  %>% data.frame -> dopca2 
rownames(dopca2) <- dopca2$from
dopca2 <- as.matrix(dopca2[,-1])
pca.ms1.2 <- prcomp(dopca2)
absorder2 <- names(sort(abs(pca.ms1.2$rotation[,1]), decreasing = T))
raworder2 <- names(sort(pca.ms1.2$rotation[,1], decreasing = T))

chainsms %>%
  filter(microstep == 1 & period == 1) %>% 
  select(-rep) %>% unique -> datplot 
datplot$from <- factor(datplot$from, levels = raworder2)
datplot$to <- factor(datplot$to, levels = raworder2)
p <- ggplot(datplot) + 
  geom_tile(aes(x = from, 
             y = to, fill = prob), color = 'black') +
  scale_fill_gradient(low = "white", high = "blue", name = "Transition\nProbability") +
  coord_fixed() + 
  labs(x = "i", y = "j") + 
  theme_classic()
ggplotly(p)

```

## Animation

- What does the underlying CTMC actually look like?

## GIF of Awesomeness

```{r make gif}
library(netvizinf)
library(network)
microsteps <- ms1
microsteps_df <- getMicrostepsDF(microsteps)
pte <- pretween_edges(microsteps = microsteps)
ptv <- pretween_vertices(pte = pte, layoutparams = list(n = 16))
pall <- tween_microsteps(ptv, pte, microsteps_df)
pgif <- netvizinf::create_net_animate(pall)
#animation::ani.options(list(interval = 1/4, ani.width = 10, ani.height = 10))
#gganimate::gganimate(pgif, "img/smallfriends.gif", title_frame = F)
```


## Interactivity with `plotly`

- `geomnet` + `ggplotly()`

## Future Work

- Shiny app for more interactivity
- Simulation studies with more visualization

## References

Pearson, M. and Michell, L. 2000. "Smoke Rings: Social Network Analysis of Friendship Groups, Smoking, and Drug-Taking." *Drugs: Education, Prevention and Policy* 7(1):21-37.

Pearson, M. and West, P. 2003. "Drifting Smoke Rings: Social Network Analysis and Markov Processes in a Longitudinal Study of Friendship Groups and Risk-Taking." *Connections* 25(2):59-76.

Steglich, C., Snijders, T.A.B, and Pearson, M. 2010. "Dynamic Networks and Behavior: Separating Selection from Influence." *Sociological Methodology.* 40(1):329-393.

Snijders, T.A.B. 1996. "Stochastic actor-oriented models for network change." *Journal of Mathematical
Sociology* 21:149-172.  

